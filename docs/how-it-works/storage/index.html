<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Automerge CRDT RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Automerge CRDT Atom Feed"><title data-react-helmet="true">Storage | Automerge CRDT</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://automerge.github.io/docs/how-it-works/storage/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Storage | Automerge CRDT"><meta data-react-helmet="true" name="description" content="From operations to changes"><meta data-react-helmet="true" property="og:description" content="From operations to changes"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://automerge.github.io/docs/how-it-works/storage/"><link data-react-helmet="true" rel="alternate" href="https://automerge.github.io/docs/how-it-works/storage/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://automerge.github.io/docs/how-it-works/storage/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.82e2244f.css">
<link rel="preload" href="/assets/js/runtime~main.10a76c8f.js" as="script">
<link rel="preload" href="/assets/js/main.ea04a768.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/automerge.png" alt="Automerge logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/automerge.png" alt="Automerge logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Automerge</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/hello/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/automerge" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/hello/">Welcome to Automerge</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/quickstart/">5-Minute Quick Start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tutorial</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Types</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Cookbook</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Internals</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-it-works/backend/">How Automerge works</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-it-works/binary-format/">Binary Document Format</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-it-works/runtime/">Runtime</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/how-it-works/storage/">Storage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how-it-works/sync/">Sync Protocol</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">API Docs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/api/">Other APIs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/glossary/">Glossary</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Storage</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="from-operations-to-changes">From operations to changes<a aria-hidden="true" class="hash-link" href="#from-operations-to-changes" title="Direct link to heading">â€‹</a></h2><p>Before applying operations received from other actors, it&#x27;s necessary to ensure that they are causally ready. This rule applies to most Operation-based CRDTs <a href="#refer-anchor-1"><sup>1</sup></a>.</p><p>We can use vector clocks to ensure that all operations are causally applied, but it is not Byzantine fault tolerant. Another way is to use Hash DAG <a href="#refer-anchor-2"><sup>2</sup></a>. By recording the dependencies of each operation, other actors can determine if it is causally ready when they receive it by checking if its dependencies exist in the current OpSet.</p><p>As the number of operations increases, maintaining the Hash DAG can become cumbersome. In Automerge, we take a different approach by using <code>change</code>. A <code>change</code> is a combination of operations, as you have seen before:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">let mut doc = Automerge::new();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut tx = doc.transaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(ROOT, &quot;name&quot;, &quot;Alice&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(ROOT, &quot;age&quot;, &quot;21&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.commit();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In this example, <code>put(root, &quot;name&quot;, &quot;Alice&quot;)</code> and <code>put(root, &quot;age&quot;, 21)</code> belong to the same transaction. When committing, we combine all operations to create a change. A change is the minimum unit of applying, which implies that all the operations in a change are either fully applied or not applied at all.</p><p>By doing so, we can manage the dependencies between changes rather than dependencies between operations. In Automerge, we use a <code>struct ChangeGraph</code> to maintain this Hash DAG:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">pub(crate) struct ChangeGraph {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nodes: Vec&lt;ChangeNode&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    edges: Vec&lt;Edge&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hashes: Vec&lt;ChangeHash&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nodes_by_hash: BTreeMap&lt;ChangeHash, NodeIdx&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>For example, a change graph created by actors may look like this:</p><img src="/assets/images/storage1-717093ac2d2d97fac7ab69a984bb2800.png" width="60%"><p>Before applying change D, it is necessary to ensure that changes B and C have already been applied, as illustrated in the diagram.</p><p>Moreover, using changes not only avoids the need to maintain a large number of dependencies but also enables us to compress operations efficiently. These operations can be viewed as a table, where each operation represents a row in the table. By utilizing columnar encoding, we can encode this table and greatly reduce the space required to store it.</p><p>Moving forward, we will explore the process of encoding these operations into a compact format. Before proceeding, you have the option to familiarize yourself with the <a href="https://automerge.org/docs/how-it-works/binary-format/" target="_blank" rel="noopener noreferrer">specification of Automerge binary encoding</a>. However, it is also possible to skip the specification for now, as we will provide essential information on encoding a basic change in the following sections. In case you encounter any difficulties, you can refer back to the specification to resolve them.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="change-encoding">Change encoding<a aria-hidden="true" class="hash-link" href="#change-encoding" title="Direct link to heading">â€‹</a></h2><p>In order to exchange changes between actors, we need to encode them. If we serialize all operations directly in sequence, it would take up a lot of space. This is because we use a large amount of metadata to describe elements in Automerge. For example, when working with text, we use UTF-8 to describe a character, but we need to use hundreds of bytes to describe metadata related to it, such as OpId, objId, and so on.</p><p>Therefore, to compress operations during the encoding of changes, we utilize columnar encoding. To give you an intuitive impression, we provide an example:</p><img src="/assets/images/storage2-7aeb194ba145282f4f33c26bdbb37470.png" width="60%"><p>When we perform columnar encoding on a table consisting of such operations, we can use <code>[5, 0@actor0]</code> to encode the <code>obj</code> column, which represents 5 occurrences of <code>0@actor0</code>.</p><p>In the next section, we will describe how to perform columnar encoding on a table of operations specifically.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="encoding">Encoding<a aria-hidden="true" class="hash-link" href="#encoding" title="Direct link to heading">â€‹</a></h3><ul><li>Run Length Encoding (RLE)</li></ul><p>Run length encoded column consists of multiple <code>(length, value)</code> pairs. For example, <code>[5, 5, 5, 3, 3]</code> can be encoded as <code>[(3, 5), (2, 3)]</code>.</p><p>To elaborate further, assuming the <code>length</code> is <code>k</code>, we follow these rules:</p><ol><li>If k &gt; 0, it means that the value is repeated <code>k</code> times.</li><li>If k = 0, it means that <code>null</code> is repeated <code>value</code> times.</li><li>If k &lt; 0, it means that the next <code>|k|</code> values are not repeated. In other words, there is no compression in this case.</li></ol><p>In Automerge, we use RLE on the following columns:</p><table><thead><tr><th>Column Name</th><th>Description</th><th>Format</th></tr></thead><tbody><tr><td>object counter</td><td>counter of the object ID each operation targets</td><td>RLE of uLEB</td></tr><tr><td>key counter</td><td>counter of the operation ID of the key of each operation</td><td>RLE of uLEB</td></tr><tr><td>key string</td><td>The string key each operation targets</td><td>RLE of UTF8 Strings</td></tr><tr><td>action</td><td>The Action of each operation</td><td>RLE of uLEB</td></tr></tbody></table><blockquote><p>uLEB (unsigned Little-Endian Base) is a variable-length encoding for unsigned integer.</p></blockquote><ul><li>Delta encoding</li></ul><p>When dealing with certain columns, RLE alone may not be efficient enough. For instance, if we have a column <code>[1, 2, 3, 5, 7]</code>, we cannot use RLE to compress it. One solution is to use delta encoding first, encoding it as <code>[+1, +1, +1, +2, +2]</code>, and then use RLE to encode it as <code>[(3, +1), (2, +2)]</code>.</p><p>In Automerge, we use delta encoding on the following columns:</p><table><thead><tr><th>Column Name</th><th>Description</th><th>Format</th></tr></thead><tbody><tr><td>counter</td><td>The counter of each operations ID</td><td>Delta encoding of uLEB</td></tr></tbody></table><ul><li>Boolean encoding</li></ul><p>For the boolean type, we can make it more compact. The column contains sequences of uLEB integers that represent the lengths of alternating sequences of false/true. The initial value of the column is always false. For example, <code>[false, true, true, true, false, false]</code> would be encoded as <code>[1, 3, 2]</code>.</p><p>In Automerge, we use boolean encoding on the following columns:</p><table><thead><tr><th>Column Name</th><th>Description</th></tr></thead><tbody><tr><td>insert</td><td>Whether or not this is an insert operation</td></tr></tbody></table><ul><li>Actor encoding</li></ul><p>Automerge utilizes a 16-byte random number to denote an actor ID. Due to its high byte count and small cardinality, it can be more efficiently managed by first saving it in a <code>index -&gt; actor ID</code> map and then storing only the index. To store the index, RLE of uLEB is used.</p><p>In Automerge, we use actor encoding on the following columns:</p><table><thead><tr><th>Column Name</th><th>Description</th></tr></thead><tbody><tr><td>object actor ID</td><td>actor index of object ID each operation targets</td></tr><tr><td>key actor ID</td><td>actor of the operation ID of the key of each operation</td></tr><tr><td>actor ID</td><td>The actor of each operations ID</td></tr></tbody></table><ul><li>Group encoding</li></ul><p>In Automerge, some columns can contain multiple values per operation. To handle this, group encoding is used. It consists of two columns:</p><ol><li><p>The first column represents the number of elements in the row and is encoded using RLE of uLEB. For instance, <code>[[1, 2], [1, 2, 3]]</code> would be encoded as <code>[2, 3]</code>.</p></li><li><p>The second column contains the actual stored values and is encoded as a flat list. For example, <code>[[1, 2], [1, 2, 3]]</code> would be encoded as <code>[1, 2, 1, 2, 3]</code>. Additionally, group encoding can be combined with other encodings such as delta encoding, which would encode <code>[1, 2, 1, 2, 3]</code> as <code>[+1, +1, -1, +1, +1]</code>.</p></li></ol><p>In Automerge, we use group encoding on the following columns:</p><table><thead><tr><th>Column Name</th><th>Description</th><th>Format</th></tr></thead><tbody><tr><td>predecessor actor IDs</td><td>The actor ID of each predecessorâ€™s operation ID</td><td>Grouped Actor encoding</td></tr><tr><td>predecessor counters</td><td>The counter of each predecessorâ€™s operation ID</td><td>Grouped Delta encoding</td></tr><tr><td>successor actor IDs</td><td>The actor ID of each successorâ€™s operation ID</td><td>Grouped Actor encoding</td></tr><tr><td>successor counters</td><td>The counter of each successorâ€™s operation ID</td><td>Grouped Delta encoding</td></tr></tbody></table><ul><li>Value encoding</li></ul><p>For primitive values, we need to indicate their type and length. Therefore, we divide the value encoding into two columns:</p><ol><li>The first column stores the value metadata, which looks like thisï¼š</li></ol><img src="/assets/images/storage3-6470ef194a5b7c28ec63029d3fcb57d8.png" width="80%"><p>The types represented by numbers <code>0</code> to <code>9</code> currently include: null, false, true, unsigned integer, signed integer, IEEE754 float, UTF8 string, bytes, counter, and timestamp.</p><ol start="2"><li>The second column stores the actual bytes.</li></ol><p>In Automerge, we use value encoding on the following columns:</p><table><thead><tr><th>Column Name</th><th>Description</th></tr></thead><tbody><tr><td>value</td><td>The value of this operation</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_y2LR" id="change-metadata">Change metadata<a aria-hidden="true" class="hash-link" href="#change-metadata" title="Direct link to heading">â€‹</a></h3><p>In addition to including all the operations, a <code>change</code> also needs to include some of its own metadata. In memory, we represent a <code>change</code> as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">pub(crate) struct Change&lt;&#x27;a, O: OpReadState&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The raw bytes of the entire chunk containing this change, including the header.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bytes: Cow&lt;&#x27;a, [u8]&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header: Header,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dependencies: Vec&lt;ChangeHash&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actor: ActorId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    other_actors: Vec&lt;ActorId&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    seq: u64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start_op: NonZeroU64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timestamp: i64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    message: Option&lt;String&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ops_meta: ChangeOpsColumns,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The range in `Self::bytes` where the ops column data is</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ops_data: Range&lt;usize&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    extra_bytes: Range&lt;usize&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _phantom: PhantomData&lt;O&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here&#x27;s a brief explanation of what these metadata mean:</p><ol><li><code>header</code> contains information about the change chunk, such as the chunk type and checksum.</li><li><code>dependencies</code> are the hash values of the changes on which this change depends.</li><li><code>actor</code> refers to the actor ID that constructed the current change.</li><li><code>other_actors</code> includes all the actors that appear later. It is actually the <code>index -&gt; ActorID</code> map.</li><li><code>seq</code> refers to the number assigned to the current change within the actor. Note that it is not the Lamport clock. <code>&lt;actor ID, seq&gt;</code> uniquely identifies a change.</li><li>The <code>start_op</code> refers to the operation ID at the beginning of the current change.</li><li><code>timestamp</code> and <code>message</code> are specified during <code>commit</code>.</li><li><code>ops_meta</code> describes the metadata of the operation table, such as which columns are included.</li><li><code>ops_data</code> includes the actual data of the operation table.</li></ol><h3 class="anchor anchorWithStickyNavbar_y2LR" id="example">Example<a aria-hidden="true" class="hash-link" href="#example" title="Direct link to heading">â€‹</a></h3><p>We use an example to illustrate how a change is encoded. Suppose we have the following code:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">let mut doc = Automerge::new();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut tx = doc.transaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(ROOT, &quot;name&quot;, &quot;Alice&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.put(ROOT, &quot;age&quot;, 21)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.commit();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It will be encoded to the byte sequence like this:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">856f4a83264ba5060140001003ebab6d29df47f39c5ea7d4cd9d6e03010100000006150a340142025604570970027e046e616d65036167650202017e8601144c69616e6772756e150200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">856f4a83fc117446013c0010ba92a37960334606aa47606579716f20010100000006150a340142025603570670027e046e616d65036167650202017e5614416c696365150200</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We can deconstruct it into different parts:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI c"><pre tabindex="0" class="prism-code language-c codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">0x856f4a83</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// magic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0xfc117446</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// checksum</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x01</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// chuck type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x3c</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// chunk length</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x00</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// dependencies</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x10</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// actor length</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0xba92a37960334606aa47606579716f20</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//actor </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x01</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// sequence number</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x01</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// start op</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x00</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// time</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x00</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// message length</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x00</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// other actors</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x06150a34014202560357067002</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// operation column metadata</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x7e046e616d65036167650202017e5614416c696365150200</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// operation columns</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="change-metadata-1">Change metadata<a aria-hidden="true" class="hash-link" href="#change-metadata-1" title="Direct link to heading">â€‹</a></h4><ul><li>magic</li></ul><p>The magic is defined as <code>[0x85, 0x6f, 0x4a, 0x83]</code>.</p><ul><li>checksum</li></ul><p>The checksum is calculated by computing the SHA256 of all subsequent parts and taking the first 4 bytes.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">SHA256(013c0010ba92a37960334606aa47606579716f20010100000006150a340142025603570670027e046e616d65036167650202017e5614416c696365150200) = fc117446c2701317ab462d610d17981fc12ac4cae6e242515d401db831a6e6d4</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>chunk type</li></ul><p>The chunk type of a change is always equal to 0x01.</p><ul><li>chunk length</li></ul><p>The chunk length indicates how many bytes follow and is of type uLEB. In this case, <code>0x3c</code> is equal to <code>0b00111100</code>, so the length of the following bytes is <code>0b011 1100</code>, which is 60 bytes.</p><ul><li>dependencies</li></ul><p>The format for dependencies is as follows: first, there is a uLEB that indicates how many dependencies there are. In this case, the value is 0, which means there are no dependencies</p><ul><li>actor length</li></ul><p>This is in uLEB format, which indicates the length of the actor in bytes. <code>0x10</code> represents 16 bytes, so the next 16 bytes represent the actor.</p><ul><li>actor</li></ul><p><code>0xba92a37960334606aa47606579716f20</code> is the actor ID.</p><ul><li>sequence number</li></ul><p>In uLEB format, it represents the seq of the change. Here, <code>0x01</code> = 1, so the sequence number is 1.</p><ul><li>start op</li></ul><p>In uLEB format, <code>0x01</code> = 1, so the start op is 1.</p><ul><li>time</li></ul><p>In uLEB format, the time is empty by default, so here <code>0x00</code> = 0.</p><ul><li>message length</li></ul><p>In uLEB format, the message is empty by default, so here <code>0x00</code> = 0.</p><ul><li>other actors</li></ul><p>It uses a uLEB to indicate how many actors there are. Here, since we have no other actors, <code>0x00</code> = 0.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="operation-column-metadata">Operation column metadata<a aria-hidden="true" class="hash-link" href="#operation-column-metadata" title="Direct link to heading">â€‹</a></h4><p>Following the uLEB <code>0x06</code> = 6 indicating the number of columns, there are 6 pairs of &lt;Column Specification, Column Length&gt;:</p><table><thead><tr><th>Column Specification</th><th>Column Length</th></tr></thead><tbody><tr><td>0x15 = 21, key string</td><td>0x0a</td></tr><tr><td>0x34 = 52, insert</td><td>0x01</td></tr><tr><td>0x42 = 66, action</td><td>0x02</td></tr><tr><td>0x56 = 86, value metadata</td><td>0x03</td></tr><tr><td>0x57 = 87, value</td><td>0x06</td></tr><tr><td>0x70 = 112, predecessor group</td><td>0x02</td></tr></tbody></table><p>The sum of <code>0x0a + 0x01 + 0x02 + 0x03 + 0x06 + 0x02</code> is 24, so the next 24 bytes are operation columns.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="operation-columns">Operation columns<a aria-hidden="true" class="hash-link" href="#operation-columns" title="Direct link to heading">â€‹</a></h4><ul><li>key stringï¼š</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">7e046e616d650361676</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In Automerge, <code>key string</code> is encoded using Run Length Encoding (RLE).</p><p>Here, the length is <code>0x7e = 0b01111110</code>, which in two&#x27;s complement is <code>-2</code>, indicating that there is no compression.</p><p>The value part is <code>046e616d6503616765</code>, which consists of several <code>&lt;uLEB byte count + actual bytes&gt;</code> pairs.</p><ol><li>The first byte count is <code>0x04 = 4</code>, indicating that the next 4 bytes is the first string, which is <code>0x6e616d65</code>, resulting in &quot;name&quot; when decoded using UTF-8.</li><li>The second byte count is <code>0x03 = 3</code>, indicating that the next 3 bytes is the second string, which is <code>0x616765</code>, resulting in &quot;age&quot; when decoded using UTF-8.</li></ol><p>Therefore, we end up with the key strings <code>[&quot;name&quot;, &quot;age&quot;]</code>.</p><ul><li>insert</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">02</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The type of <code>insert</code> is boolean, which is encoded using <code>Boolean Encoding</code>.</p><p>Therefore, <code>[0x02]</code> represents <code>[false, false]</code>.</p><ul><li>action</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">0201</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>RLE is used for the action column. Here, <code>0x02</code> = 2, indicating that the value is repeated twice.</p><p>The value part is <code>0x01</code>. Repeating it twice gives us <code>[0x01, 0x01]</code>.</p><p>According to the Automerge specification, <code>0x01</code> as the action value means &quot;set&quot;. Therefore, the action column is <code>[set, set]</code>.</p><ul><li>value metadata</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">7e5614</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The value metadata is encoded using the <code>Value Encoding</code>.</p><p><code>0x56 = 0101 0110</code> can be interpreted as <code>0b 101 0110</code>, which means the first type is <code>0b0110</code> (String), and the length is <code>0b101 = 5 bytes</code>.</p><p>The following <code>0x14 = 0b0001 0100</code>,  indicates that the second type is <code>0b100</code> (Signed Integer), and the length is <code>0b1 = 1 byte</code>.</p><p>So the entire value metadata column can be interpreted as <code>[&lt;String, 8&gt;, &lt;Signed Integer, 1&gt;]</code>.</p><ul><li>value</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">416c69636515</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>0x416c696365</code> is converted to the UTF-8 string &quot;Alice&quot;. And <code>0x15 = 21</code>.</p><p>Therefore, the value column can be interpreted as <code>[&quot;Alice&quot;, 21]</code>.</p><ul><li>predecessor group</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">0200</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The first column of the predecessor group is encoded using RLE, which is equivalent to <!-- -->[0x00, 0x00]<!-- --> here. This means that there are no predecessors for these two operations. Therefore, the predecessor group is interpreted as <code>[[], []]</code>.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="document-encoding">Document encoding<a aria-hidden="true" class="hash-link" href="#document-encoding" title="Direct link to heading">â€‹</a></h2><p>A new actor may start joining the synchronization of a document without any changes. It is inefficient to transmit each change individually. In this scenario, we can serialize and transmit the entire document. Furthermore, serialization of the document is also useful when we intend to persist it in disk storage.</p><p>The document is essentially a set of changes. However, when we encode it, we divide it into two distinct tables: the change table and the operation table. The change table stores the metadata related to the changes, whereas the operation table stores all the operations of the document.</p><p>The reason why we separate the change table and the operation table is that doing so allows us to better utilize columnar encoding, which results in higher compression rates.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">pub(crate) struct Document&lt;&#x27;a&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bytes: Cow&lt;&#x27;a, [u8]&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #[allow(dead_code)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compressed_bytes: Option&lt;Cow&lt;&#x27;a, [u8]&gt;&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header: Header,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actors: Vec&lt;ActorId&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    heads: Vec&lt;ChangeHash&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    op_metadata: DocOpColumns,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    op_bytes: Range&lt;usize&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    change_metadata: DocChangeColumns,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    change_bytes: Range&lt;usize&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #[allow(dead_code)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    head_indices: Vec&lt;u64&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="example-1">Example<a aria-hidden="true" class="hash-link" href="#example-1" title="Direct link to heading">â€‹</a></h3><p>We use an example to illustrate how a document is encoded. Suppose we have the following code:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI rust"><pre tabindex="0" class="prism-code language-rust codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">let mut doc = Automerge::new();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut tx1 = doc.transaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx1.put(ROOT, &quot;name&quot;, &quot;Bob&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx1.put(ROOT, &quot;age&quot;, 21)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx1.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut tx2 = doc.transaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx2.put(ROOT, &quot;gender&quot;, &quot;male&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx2.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">doc.save();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It will be encoded to the byte sequence like this:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">856f4a83e7a6f50e009301011013336ec1ed354befa60b3e3f05346028012f2f0a65b40461263a496749d8bb0b0746c234cbddb092e11473861242638a0c07010203021303230240034302560208151121022304340142025605570d800102020002017e020102007e00017f0002077d036167650667656e646572046e616d6503007d02017e0303017d14468601156d616c654c69616e6772756e030001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">856f4a834afcae9c008d01011015cb7623f0314fc09773daafcf4138d7016cdffc539c7e02a93ab4f9762fc4466b90fc4134c6662382d067f02d9e9418bf070102030213032302400343025602081511210223043401420256045708800102020002017e020102007e00017f0002077d036167650667656e646572046e616d6503007d02017e0303017d144636156d616c65426f62030001</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We can deconstruct it into different parts:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI c"><pre tabindex="0" class="prism-code language-c codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">0x856f4a83</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// magic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x4afcae9c</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// checksum</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x00</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// chunk type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x8d01</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// chunk length</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x011015cb7623f0314fc09773daafcf4138d7</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// actors</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x016cdffc539c7e02a93ab4f9762fc4466b90fc4134c6662382d067f02d9e9418bf</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// heads</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x070102030213032302400343025602</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// change column metadata</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x081511210223043401420256045708800102</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// operation column metadata</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x020002017e020102007e00017f000207</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// change column</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x7d036167650667656e646572046e616d6503007d02017e0303017d144636156d616c65426f620300</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// operation columns</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0x01</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// heads index</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As most of the fields are similar to change encoding, we will not explain them here. Instead, we will only illustrate the <code>change column metadata</code> , <code>operation column metadata</code>,  <code>change column</code> and <code>operation column</code> .</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="change-columns-metadata">change columns metadata<a aria-hidden="true" class="hash-link" href="#change-columns-metadata" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">0x070102030213032302400343025602</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Following the uLEB <code>0x07</code> = 7 indicating the number of columns, there are 7 pairs of &lt;Column Specification, Column Length&gt;:</p><table><thead><tr><th>Column Specification</th><th>Column Length</th></tr></thead><tbody><tr><td>0x01 = 1, actor</td><td>0x02</td></tr><tr><td>0x03 = 3, sequence number</td><td>0x02</td></tr><tr><td>0x13 = 19, maxop</td><td>0x03</td></tr><tr><td>0x23 = 35, time</td><td>0x02</td></tr><tr><td>0x40 = 64, dependencies group</td><td>0x03</td></tr><tr><td>0x43 = 67, dependencies index</td><td>0x02</td></tr><tr><td>0x56 = 86, extra metadata</td><td>0x02</td></tr></tbody></table><p>0x02 + 0x02 + 0x03 + 0x02 + 0x03 + 0x02 + 0x02 = 16 bytes.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="operation-columns-metadata">operation columns metadata<a aria-hidden="true" class="hash-link" href="#operation-columns-metadata" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">0x081511210223043401420256045708800102</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Following the uLEB <code>0x08</code> = 8 indicating the number of columns, there are 8 pairs of &lt;Column Specification, Column Length&gt;:</p><table><thead><tr><th>Column Specification</th><th>Column Length</th></tr></thead><tbody><tr><td>0x15 = 21, key string</td><td>0x11</td></tr><tr><td>0x21 = 33, actor ID</td><td>0x02</td></tr><tr><td>0x23 = 35, counter</td><td>0x04</td></tr><tr><td>0x34 = 52, insert</td><td>0x01</td></tr><tr><td>0x42 = 66, action</td><td>0x02</td></tr><tr><td>0x56 = 86, value metadata</td><td>0x04</td></tr><tr><td>0x57 = 87, value</td><td>0x08</td></tr><tr><td>0x8001 = 128, successor group</td><td>0x02</td></tr></tbody></table><p>0x11 + 0x02 + 0x04 + 0x01 + 0x02 + 0x04 + 0x08 + 0x02 = 40 bytes</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="change-columns">change columns<a aria-hidden="true" class="hash-link" href="#change-columns" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">0x020002017e020102007e00017f000207</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>actor</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">0200</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The actor column uses RLE. First, the length is <code>0x02</code>, indicating that the value is repeated twice. Then, the value is <code>0x00</code>, indicating that the actor column is <!-- -->[0x00, 0x00]<!-- -->.</p><p>In this case, 0x00 refers to the first actor in the actors list, which is <code>0x011015cb7623f0314fc09773daafcf4138d7</code>.</p><ul><li>sequence number</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">0201</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The sequence number uses RLE. Here, the length is 0x02, indicating that the value is repeated twice. The value is <code>0x01</code>, which means that the actual value is <!-- -->[0x01, 0x01]<!-- -->.</p><p>The value part of the sequence number uses delta encoding. Therefore, <!-- -->[0x01, 0x01]<!-- --> is equivalent to <!-- -->[1, 2]<!-- -->.</p><ul><li>maxop</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">7e0201</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>maxop</code>  uses RLE. Here, the length is <code>0x7e</code>, which is equivalent to <code>-2</code> in 2&#x27;s comlement number format. The value is <code>0x0201</code>, which mean the actual value is <!-- -->[0x02, 0x01]<!-- -->.</p><p>Since it is delta encoded, this value represents <!-- -->[0x02, 0x03]<!-- -->.</p><ul><li>time</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">0200</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The length of the RLE is <code>0x02</code>, indicating that <code>0x00</code> is repeated twice. Therefore, time is not recorded here.</p><ul><li>dependencies group</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">7e0001</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Dependencies group can be interpreted as <!-- -->[0x00, 0x01]<!-- -->. As a result, the first change has no dependencies, while the second change has one dependency.</p><ul><li>dependencies index</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">7f00</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>0x7f</code> is equivalent to <code>-1</code> in RLE encoding, indicating that the value is not repeated. The following value is <code>0x00</code>. The dependencies index for the two changes is therefore: [[], <!-- -->[0x00]<!-- -->].</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="operation-columns-1">operation columns<a aria-hidden="true" class="hash-link" href="#operation-columns-1" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">0x7d036167650667656e646572046e616d6503007d02017e0303017d144636156d616c65426f620300</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>key string</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">7d036167650667656e646572046e616d65</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>0x7d</code>  is <code>-3</code> in 2&#x27;s complement, indicating that the value is not repeated. The value part is as follows:</p><ol><li>03 represents the length of the first value, so the next three bytes are <code>0x616765</code>, which corresponds to &quot;age&quot;.</li><li>06 represents the length of the second value, so the next six bytes are <code>0x67656e646572</code>, which corresponds to &quot;gender&quot;.</li><li>04 represents the length of the third value, so the next four bytes are <code>0xe616d65</code>, which corresponds to &quot;name&quot;.</li></ol><p>Therefore, the final result is <!-- -->[&quot;age&quot;, &quot;gender&quot;, &quot;name&quot;]<!-- -->.</p><ul><li>actor ID</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">0300</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here is RLE encoded, so <code>0x03</code> represents repeating 3 times, and the value is <code>0x00</code>. Therefore, the final decoding result is <!-- -->[0x00, 0x00, 0x00]<!-- -->.</p><ul><li>counter</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">7d02017e</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The value <code>0x7d</code> indicates that there is no repetition, and the sequence of values <code>0x02 0x01 0x7e</code> represents the delta encoding <!-- -->[+2, +1, -2]<!-- -->. The resulting decoded sequence is <!-- -->[2, 3, 1]<!-- -->.</p><ul><li>insert</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">03</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>0x03</code> represents 3 times <code>false</code>, which is <!-- -->[false, false, false]<!-- -->.</p><ul><li>action</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">0301</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>0301</code> represents three times <code>0x01</code>, which means <!-- -->[0x01, 0x01, 0x01]<!-- -->.</p><p>According to the Automerge specification, <code>0x01</code> as the action value means &quot;set&quot;. Therefore, the action column is <code>[set, set, set]</code>.</p><ul><li>value metadata</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">7d144636</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>0x7d</code> = -3, which means there is no compression used.</p><p>Next is the value part, which consists of several 64-bit uLEBs:</p><ol><li><code>14</code> = 0001 0100, which means type = 0b100 (Signed integer), length = 0b1 = 1 byte.</li><li><code>46</code> = 0100 0110, which means type = 0b110 (String), length = 0b100 = 4 bytes.</li><li><code>36</code> = 0011 0110, which means type = 0b110 (String), length = 0b11 = 3 bytes.</li></ol><p>Therefore, the entire value metadata column can be interpreted as <!-- -->[&lt;Signed Integer, 1&gt;, &lt;String, 4&gt;, &lt;String, 3&gt;]<!-- -->.</p><ul><li>value</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">156d616c65426f62</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol><li>Signed Integer, <code>0x15</code> = 21</li><li>String, <code>0x6d616c65</code> = &quot;male&quot;</li><li>String, <code>0x426f62</code> = &quot;Bob&quot;</li></ol><p>Therefore, the entire value column can be interpreted as <!-- -->[21, &quot;male&quot;, &quot;Bob&quot;]<!-- -->.</p><ul><li>successor group</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">0300</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>0x0300</code> means three times <code>0x00</code>, which is equivalent to <!-- -->[0x00, 0x00, 0x00]<!-- -->.</p><p>So there is no successor for all the operations. Hence the operation group can be interpreted as <code>[[], [], []]</code>.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="reference">Reference<a aria-hidden="true" class="hash-link" href="#reference" title="Direct link to heading">â€‹</a></h2><div id="refer-anchor-1"></div><p>[1]<!-- -->. M. Shapiro, N. PreguiÃ§a, C. Baquero, and M. Zawirski, â€œConflict-free replicated data types,â€ <em>Lecture Notes in Computer Science</em>, pp. 386â€“400, 2011. doi:10.1007/978-3-642-24550-3_29 </p><div id="refer-anchor-2"></div><p>[2]<!-- -->. Kleppmann M, Howard H. Byzantine eventual consistency and the fundamental limits of peer-to-peer databases<!-- -->[J]<!-- -->. arXiv preprint arXiv:2012.00472, 2020.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/automerge/automerge.github.io/edit/main/docs/how-it-works/storage.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/how-it-works/runtime/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Runtime</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/how-it-works/sync/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Sync Protocol<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#from-operations-to-changes" class="table-of-contents__link toc-highlight">From operations to changes</a></li><li><a href="#change-encoding" class="table-of-contents__link toc-highlight">Change encoding</a><ul><li><a href="#encoding" class="table-of-contents__link toc-highlight">Encoding</a></li><li><a href="#change-metadata" class="table-of-contents__link toc-highlight">Change metadata</a></li><li><a href="#example" class="table-of-contents__link toc-highlight">Example</a></li></ul></li><li><a href="#document-encoding" class="table-of-contents__link toc-highlight">Document encoding</a><ul><li><a href="#example-1" class="table-of-contents__link toc-highlight">Example</a></li></ul></li><li><a href="#reference" class="table-of-contents__link toc-highlight">Reference</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/tutorial/introduction/">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/automerge/shared_invite/zt-e4p3760n-kKh7r3KRH1YwwNfiZM8ktw" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack community<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://inkandswitch.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Ink &amp; Switch<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog/">Blog</a></li><li class="footer__item"><a href="https://github.com/automerge/automerge" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 Automerge contributors. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.10a76c8f.js"></script>
<script src="/assets/js/main.ea04a768.js"></script>
</body>
</html>